
IM的消息收发过程中的三个阶段：
消息上行
IM服务端处理
消息下行

![image](https://user-images.githubusercontent.com/17738389/111248483-e7fae180-8601-11eb-9745-31934029dff2.png)


【消息上行】指用户消息到达IM服务端的过程

用户通过SDK与IM接入层之间简历的加密信道或者REST API https的方式，将消息经由IM接入层，发送给IM服务端。

在接入层，

【IM服务端处理】针对不同场景会有很多复杂的处理逻辑，这里列举部分：

登录/鉴权

禁言、黑名单、好友关系链检查

回调处理

安全打击

更新最近联系人

存储消息

【消息下行】指消息从IM服务端下发到用户终端的过程

查用户状态

消息扩散

离线推送

在这三个阶段中，IM是如何保证消息收发的实时性、可靠性的呢？下面详细来看：

实时性：保证消息收发能够尽快完成，减少延迟
既然是即时通信，消息收发的实时性需要首先保证，通常有这么几种实际方案：

【方案1】短轮询：也就是普通的一问一答的请求响应模式，比如我们浏览网站

优点：系统实现简单

缺点：为了提升实时性，势必提高短轮询频率，这里面大部分短轮询请求都是无用的，浪费客户端资源；高频请求对服务端的资源消耗大。

【方案2】长轮询：相较短轮询，请求会在服务端等待一段时间再返回

优点：相较短轮询能大幅降低无用轮询请求

缺点：实际上没有完全解决服务端资源消耗大的问题

【方案3】长连接服务端推送：通过私有协议建立的加密消息通道双向

优点：服务端推送的双向通信，大幅降低服务端轮询压力，减少数据交互的控制开销

云通信采用了长轮询和服务端推送结合的方式：

针对WEB端&小程序端，和直播群，使用长轮询的方式。细节以后再讲。

其他场景使用服务端推送的方式。

可靠性：不丢消息，消息不重复
我们先思考一下消息丢失的几种情况。下图是用户A给用户B发送一条消息的时序图，1、2、3、4哪些步骤可能丢消息呢：
![image](https://user-images.githubusercontent.com/17738389/111248553-0fea4500-8602-11eb-9774-cec98699cb08.png)


1用户 A 发送消息到 IM 服务器 --- 消息上行
2服务端完成处理，3返回给客户端成功 --- IM服务端处理

4推送消息给客户端 --- 消息下行

实际上，4个步骤都有可能失败，比如：

1：因为网络原因，用户A的请求没有到达IM服务器

2：IM服务端存储消息失败了

3：IM服务端处理耗时长，没有在超时时间内返回客户端结果

4：消息下行过程中，IM服务故障/用户终端故障导致收到消息无法写入DB 等

怎么解决？

其实很简单，针对1、2、3，我们给每条消息设置一个唯一ID， 客户端只要重试直到收到IM的返回，而IM服务端针对ID有去重机制，不会导致消息重复处理。

针对4，需要用到一个类似TCP协议中的ACK确认机制：

![image](https://user-images.githubusercontent.com/17738389/111248564-1678bc80-8602-11eb-8dfd-d0f06da85416.png)


IM服务端将推送出的消息添加到待ACK队列里，直到接受到客户端的确认ACK，整个推送过程才算结束。如果没有收到则会一直重发，而客户端针对消息的唯一ID也有去重机制，保证指挥接收到同一条消息一次，不影响体验。

到此，ACK+重传+去重的机制， 是否已经可以完美解决消息收发的可靠性的问题呢？还没有，还遗漏了一点：假如重传这个步骤失败了（例如IM服务器宕机导致的重传失败）怎么办？

![image](https://user-images.githubusercontent.com/17738389/111248573-1aa4da00-8602-11eb-8b63-d615b20e6776.png)


以单聊消息举例， 客户端每收到一条消息，都会用时间戳机制，来未读消息库做消息同步，这样即使IM服务端重传失败了，客户端也能主动补全，保证不丢消息。

一致性：消息不重复，不乱序
单聊：通过每条消息在服务端的时间戳来排序

群聊：通过每个群里每条消息的seq值来排序

安全性：消息不被窃取
消息的安全性可以说是一个IM服务能否存在的立命之本。从消息传输、消息存储、消息内容三方面来看：

消息传输安全：IM接入使用httpDNS来避免域名劫持；SDK和IM后台间使用加密信道+私有协议/HTTPS，防止信息截获、篡改、伪造。

消息存储安全：独立登录模式是基于hmac sha的用户签名计算；消息拉取需要加密信道+用户签名认证。

消息内容安全：使用腾讯云天御进行敏感信息识别，业务可以根据业务需求灵活处理。
